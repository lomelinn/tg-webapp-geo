<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Captura Segura de Ubicaci√≥n</title>
  <meta name="description" content="Mini App de Telegram para capturar ubicaci√≥n verificada.">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { color-scheme: light dark; }
    html, body { margin:0; padding:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, 'Helvetica Neue', Arial; }
    body { background: var(--tg-theme-bg-color, #0f1115); color: var(--tg-theme-text-color, #e8e8e8); }
    .wrap { padding: 16px; max-width: 520px; margin: 0 auto; }
    h1 { font-size: 20px; margin: 0 0 8px; }
    p { opacity: .85; margin: 0 0 16px; }
    .card { background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08); border-radius: 14px; padding: 16px; }
    .row { display: flex; gap: 10px; align-items: center; justify-content: space-between; }
    .btn { appearance: none; border: 0; border-radius: 12px; padding: 14px 16px; width: 100%; font-weight: 600; cursor: pointer; }
    .btn-primary { background: var(--tg-theme-button-color, #2ea6ff); color: var(--tg-theme-button-text-color, #fff); }
    .btn-ghost { background: transparent; color: inherit; border: 1px dashed rgba(255,255,255,.3); }
    .muted { font-size: 12px; opacity: .7; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre-wrap; font-size: 12px; background: rgba(0,0,0,.25); border-radius: 10px; padding: 10px; margin-top: 10px; min-height: 70px; }
    .ok { color: #00d084; }
    .err { color: #ff6b6b; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üìç Captura Segura de Ubicaci√≥n</h1>
    <p>Esta pantalla usa la <strong>Telegram WebApp</strong> firmada. Abre este sitio desde el bot√≥n del bot.</p>

    <div class="card" id="card">
      <div class="row" style="margin-bottom: 12px;">
        <button class="btn btn-primary" id="btnGet">Obtener y Enviar Ubicaci√≥n</button>
      </div>
      <div class="row">
        <button class="btn btn-ghost" id="btnClose">Cerrar</button>
      </div>
      <div class="log" id="log"></div>
      <p class="muted">Tip: da permiso de ubicaci√≥n a Telegram. No uses el clip.</p>
    </div>
  </div>

  <script>
    (function(){
      var tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
      var logEl = document.getElementById('log');
      var btnGet = document.getElementById('btnGet');
      var btnClose = document.getElementById('btnClose');

      function log(msg, cls) {
        try {
          var p = document.createElement('div');
          if (cls) p.className = cls;
          p.textContent = msg;
          logEl.appendChild(p);
          logEl.scrollTop = logEl.scrollHeight;
          console.log("[WEBAPP]", msg);
        } catch(e) { console.log("[WEBAPP][LOG_ERR]", e && e.message ? e.message : e); }
      }

      function qs(name) {
        var m = new RegExp("[?&]" + name + "=([^&]+)").exec(location.search);
        return m ? decodeURIComponent(m[1]) : "";
      }

      function ready() {
        try {
          if (tg && tg.ready) tg.ready();
          if (tg && tg.expand) tg.expand();
          log("WebApp lista.", "ok");
          var id = (tg && typeof tg.initData === "string") ? tg.initData : "";
          if (!id || id.length === 0) log("‚ö†Ô∏è initData AUSENTE (ok: usaremos firma de URL).", "err");
          else log("initData OK (len=" + id.length + ")", "ok");

          var n = qs("n"), s = qs("s");
          if (n && s) log("Firma URL presente ‚úî", "ok");
          else log("‚ö†Ô∏è Falta firma URL en query (n/s). Aseg√∫rate de abrir desde /ubicacion.", "err");
        } catch (e) {
          log("WebApp init error: " + (e && e.message ? e.message : e), "err");
        }
      }

      function getAndSendLocation() {
        btnGet.disabled = true;
        log("Solicitando geolocalizaci√≥n del dispositivo...");

        if (!navigator.geolocation) {
          log("Geolocalizaci√≥n no disponible en este dispositivo.", "err");
          btnGet.disabled = false;
          return;
        }

        var opts = { enableHighAccuracy: true, maximumAge: 0, timeout: 12000 };
        var initData = (tg && typeof tg.initData === "string") ? tg.initData : "";
        var n = qs("n"), s = qs("s");

        navigator.geolocation.getCurrentPosition(
          function success(position){
            try {
              var c = position && position.coords ? position.coords : {};
              var latitude = Number(c.latitude);
              var longitude = Number(c.longitude);
              var accuracy = (typeof c.accuracy === "number") ? Math.round(c.accuracy) : null;
              var t = Date.now();

              log("OK: lat=" + latitude + " lon=" + longitude + " acc=" + accuracy + "m", "ok");

              var payload = {
                src: "webapp",
                t: t,
                lat: latitude,
                lon: longitude,
                acc: accuracy,
                initData: initData, // puede venir vac√≠o; el bot usar√° la firma URL
                n: n,
                s: s
              };
              var text = JSON.stringify(payload);

              if (tg && typeof tg.sendData === "function") {
                tg.sendData(text);
                log("Datos enviados al bot. Puedes cerrar esta ventana.", "ok");
                setTimeout(function(){ if (tg && tg.close) tg.close(); }, 600);
              } else {
                log("No se pudo enviar al bot: sendData no disponible (¬øno est√°s dentro de Telegram?).", "err");
                btnGet.disabled = false;
              }
            } catch(e) {
              log("Error armando/enviando payload: " + (e && e.message ? e.message : e), "err");
              btnGet.disabled = false;
            }
          },
          function error(err){
            log("Error de geolocalizaci√≥n: " + (err && err.message ? err.message : JSON.stringify(err)), "err");
            btnGet.disabled = false;
          },
          opts
        );
      }

      btnGet.addEventListener('click', getAndSendLocation);
      btnClose.addEventListener('click', function(){ if (tg && tg.close) tg.close(); });
      ready();
    })();
  </script>
</body>
</html>
